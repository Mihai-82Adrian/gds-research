<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saliency Map: go_to_barber ‚Üí supermarket</title>
    
    <!-- PDF/SVG Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js" integrity="sha512-Bw9Zj8x4giJb3OmlMiMaGbNrFr0ERD2f9jL3en5FmcTXLhkI+fKyXVeyGyxKMIl1RfgcCBDprJJt4JvlglEb3A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 1400px;
            width: 100%;
        }
        h1 {
            color: #2d3748;
            margin-top: 0;
            text-align: center;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .svg-container {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin-bottom: 30px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #2d3748;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .metric-card {
            background: #edf2f7;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .metric-label {
            color: #4a5568;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .metric-value {
            color: #2d3748;
            font-size: 1.5em;
            font-weight: bold;
        }
        .node-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }
        
        /* Export buttons */
        .export-toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 2000;
        }
        .export-btn {
            background: white;
            border: 2px solid #5a67d8;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9em;
            font-weight: 600;
            color: #5a67d8;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .export-btn:hover {
            background: #5a67d8;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90,103,216,0.3);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        .export-btn.loading {
            opacity: 0.6;
            cursor: wait;
        }
        
        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
                margin: 0;
            }
            .export-toolbar {
                display: none;
            }
            .uncertainty-legend {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        /* Uncertainty glyph animations */
        @keyframes pulse-uncertainty {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        
        .pulse-uncertainty {
            animation: pulse-uncertainty 2s ease-in-out infinite;
        }
        
        /* Respect user's motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .pulse-uncertainty {
                animation: none;
            }
        }
        </style>
</head>
<body>
    <!-- Export Toolbar -->
    <div class="export-toolbar" role="toolbar" aria-label="Export options">
        <button class="export-btn" onclick="window.history.back()" aria-label="Go back to documentation">
            <span>‚Üê</span>
            <span>Back to Documentation</span>
        </button>
        <button class="export-btn" id="exportPdfBtn" aria-label="Export visualization as PDF">
            <span>üìÑ</span>
            <span>Export PDF</span>
        </button>
        <button class="export-btn" id="exportSvgBtn" aria-label="Download SVG graphic">
            <span>üé®</span>
            <span>Download SVG</span>
        </button>
    </div>
    
    <main class="container" role="main" aria-label="XAI Saliency Map Visualization">
        <header>
            <h1>üó∫Ô∏è Saliency Map: Saliency Map: go_to_barber ‚Üí supermarket</h1>
            <p class="subtitle">Node and Edge Importance Visualization</p>
        </header>
        
        <div class="svg-container" tabindex="0" role="region" aria-label="Interactive knowledge graph showing reasoning path">
            <svg width="1200" height="600" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Knowledge graph showing 4 nodes with importance scores">
    <defs>
        <!-- Epistemic Uncertainty: Blur filter (knowledge limits) -->
        <filter id="epistemic-blur-low" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="1" />
        </filter>
        <filter id="epistemic-blur-medium" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="2" />
        </filter>
        <filter id="epistemic-blur-high" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="3" />
        </filter>
        
        <!-- Aleatoric Uncertainty: Stripe pattern (data noise) -->
        <pattern id="aleatoric-pattern-low" patternUnits="userSpaceOnUse" width="4" height="4">
            <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" 
                  style="stroke:#ffffff; stroke-width:0.5; opacity:0.2;" />
        </pattern>
        <pattern id="aleatoric-pattern-medium" patternUnits="userSpaceOnUse" width="4" height="4">
            <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" 
                  style="stroke:#ffffff; stroke-width:0.8; opacity:0.4;" />
        </pattern>
        <pattern id="aleatoric-pattern-high" patternUnits="userSpaceOnUse" width="4" height="4">
            <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" 
                  style="stroke:#ffffff; stroke-width:1.2; opacity:0.6;" />
        </pattern>
        
        <!-- High Total Uncertainty: Dot pattern overlay -->
        <pattern id="high-uncertainty-dots" patternUnits="userSpaceOnUse" width="8" height="8">
            <circle cx="4" cy="4" r="1.5" fill="#fbbf24" opacity="0.6" />
        </pattern>
    </defs>
<line x1="375" y1="300" x2="525" y2="300" stroke="#e53e3e" stroke-width="7.085971" opacity="0.6" /><text x="450" y="295" text-anchor="middle" fill="rgb(74,85,104)" font-size="12" font-weight="bold">0.87</text><line x1="525" y1="300" x2="675" y2="300" stroke="#e53e3e" stroke-width="7.006937" opacity="0.6" /><text x="600" y="295" text-anchor="middle" fill="rgb(74,85,104)" font-size="12" font-weight="bold">0.94</text><line x1="675" y1="300" x2="825" y2="300" stroke="#e53e3e" stroke-width="6.907093" opacity="0.6" /><text x="750" y="295" text-anchor="middle" fill="rgb(74,85,104)" font-size="12" font-weight="bold">1.04</text><circle class="node-circle" cx="375" cy="300" r="30" fill="#e53e3e" stroke="#4a5568" stroke-width="2" data-lemma="go_to_barber" data-score="1" data-m0="11.107938" data-epistemic="0.0" data-aleatoric="4.4" data-total-uncertainty="2.2" style="cursor: pointer;" role="img" aria-label="Node: go_to_barber, Importance: 100%, Epistemic Uncertainty: 0%, Aleatoric Uncertainty: 4%" /><text x="375" y="350" text-anchor="middle" fill="rgb(45,55,72)" font-size="14" font-weight="bold">go_to_barber</text><text x="375" y="305" text-anchor="middle" fill="white" font-size="12" font-weight="bold">100%</text><circle class="node-circle" cx="525" cy="300" r="30" fill="#e53e3e" stroke="#2d3748" stroke-width="4" data-lemma="cut_hair" data-score="1" data-m0="5.7111487" data-epistemic="0.0" data-aleatoric="5.5" data-total-uncertainty="2.8" style="cursor: pointer;" role="img" aria-label="Node: cut_hair, Importance: 100%, Epistemic Uncertainty: 0%, Aleatoric Uncertainty: 6%" /><text x="525" y="350" text-anchor="middle" fill="rgb(45,55,72)" font-size="14" font-weight="bold">cut_hair</text><text x="525" y="305" text-anchor="middle" fill="white" font-size="12" font-weight="bold">100%</text><text x="550" y="280" text-anchor="middle" fill="rgb(229,62,62)" font-size="16">‚≠ê</text><circle class="node-circle" cx="675" cy="300" r="30" fill="#e53e3e" stroke="#2d3748" stroke-width="4" data-lemma="mass" data-score="1" data-m0="5.475426" data-epistemic="0.0" data-aleatoric="6.6" data-total-uncertainty="3.3" style="cursor: pointer;" role="img" aria-label="Node: mass, Importance: 100%, Epistemic Uncertainty: 0%, Aleatoric Uncertainty: 7%" /><text x="675" y="350" text-anchor="middle" fill="rgb(45,55,72)" font-size="14" font-weight="bold">mass</text><text x="675" y="305" text-anchor="middle" fill="white" font-size="12" font-weight="bold">100%</text><text x="700" y="280" text-anchor="middle" fill="rgb(229,62,62)" font-size="16">‚≠ê</text><circle class="node-circle" cx="825" cy="300" r="30" fill="#e53e3e" stroke="#2d3748" stroke-width="4" data-lemma="supermarket" data-score="1" data-m0="9.5340395" data-epistemic="0.0" data-aleatoric="7.7" data-total-uncertainty="3.9" style="cursor: pointer;" role="img" aria-label="Node: supermarket, Importance: 100%, Epistemic Uncertainty: 0%, Aleatoric Uncertainty: 8%" /><text x="825" y="350" text-anchor="middle" fill="rgb(45,55,72)" font-size="14" font-weight="bold">supermarket</text><text x="825" y="305" text-anchor="middle" fill="white" font-size="12" font-weight="bold">100%</text><text x="850" y="280" text-anchor="middle" fill="rgb(229,62,62)" font-size="16">‚≠ê</text></svg>
        </div>
        
        <div class="legend" role="region" aria-label="Color legend for importance levels">
            <div class="legend-item">
                <div class="legend-color" style="background: #e53e3e;"></div>
                <span><strong>High</strong> (0.8-1.0)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ed8936;"></div>
                <span><strong>Medium-High</strong> (0.6-0.8)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ecc94b;"></div>
                <span><strong>Medium</strong> (0.4-0.6)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #48bb78;"></div>
                <span><strong>Medium-Low</strong> (0.2-0.4)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4299e1;"></div>
                <span><strong>Low</strong> (0.0-0.2)</span>
            </div>
        </div>
        
        <div class="uncertainty-legend" role="region" aria-label="Uncertainty glyph explanation" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: white;
        ">
            <p style="margin: 0 0 15px 0; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3em;">üî¨</span> Glyphs for Uncertainty (Research Feature)
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                    <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                        <filter id="demo-blur"><feGaussianBlur stdDeviation="3"/></filter>
                        <circle cx="25" cy="25" r="20" fill="#e53e3e" style="filter: url(#demo-blur);"/>
                    </svg>
                    <div style="flex: 1; font-size: 0.9em;">
                        <strong style="display: block; margin-bottom: 3px;">Blur Effect</strong>
                        <span style="opacity: 0.9;">Epistemic uncertainty<br>(knowledge limits)</span>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                    <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <pattern id="demo-stripes" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                                <line x1="0" y1="0" x2="0" y2="8" stroke="rgba(255,255,255,0.5)" stroke-width="4"/>
                            </pattern>
                        </defs>
                        <circle cx="25" cy="25" r="20" fill="url(#demo-stripes)" stroke="#ed8936" stroke-width="2"/>
                    </svg>
                    <div style="flex: 1; font-size: 0.9em;">
                        <strong style="display: block; margin-bottom: 3px;">Stripe Pattern</strong>
                        <span style="opacity: 0.9;">Aleatoric uncertainty<br>(data noise)</span>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;">
                    <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="25" cy="25" r="20" fill="#ecc94b" style="animation: pulse-uncertainty 2s ease-in-out infinite;"/>
                    </svg>
                    <div style="flex: 1; font-size: 0.9em;">
                        <strong style="display: block; margin-bottom: 3px;">Pulse Animation</strong>
                        <span style="opacity: 0.9;">High total uncertainty<br>(&gt;25% combined)</span>
                    </div>
                </div>
            </div>
            <p style="margin: 12px 0 0 0; font-size: 0.85em; opacity: 0.85; font-style: italic;">
                üí° Hover over nodes to see detailed uncertainty metrics. Combining epistemic and aleatoric visualizations helps identify which uncertainties come from knowledge gaps vs. inherent randomness.
            </p>
        </div>
        
        <div class="metrics" role="region" aria-label="Path metrics summary">
            <div class="metric-card">
                <div class="metric-label">Critical Nodes</div>
                <div class="metric-value">3</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Nodes</div>
                <div class="metric-value">4</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Importance Score</div>
                <div class="metric-value">1.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Attribution Method</div>
                <div class="metric-value" style="font-size: 0.9em;">Frequency-weighted positional attribution</div>
            </div>
        </div>
    </main>
    
    <div class="node-tooltip" id="tooltip" role="tooltip" aria-live="polite"></div>
    
    <script>
        // Tooltip handling
        const tooltip = document.getElementById('tooltip');
        const nodes = document.querySelectorAll('.node-circle');
        
        nodes.forEach(node => {
            node.addEventListener('mouseenter', (e) => {
                const lemma = node.getAttribute('data-lemma');
                const score = node.getAttribute('data-score');
                const m0 = node.getAttribute('data-m0');
                const epistemic = node.getAttribute('data-epistemic');
                const aleatoric = node.getAttribute('data-aleatoric');
                const totalUnc = node.getAttribute('data-total-uncertainty');
                
                let tooltipHTML = "<strong>" + lemma + "</strong><br>" +
                    "Importance: " + (parseFloat(score) * 100).toFixed(0) + "%<br>" +
                    "Frequency (m0): " + parseFloat(m0).toFixed(2);
                
                // Add uncertainty info if available
                if (epistemic && aleatoric && totalUnc) {
                    tooltipHTML += "<hr style='margin: 5px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.3);'>" +
                        "<em style='font-size: 0.85em;'>Uncertainty:</em><br>" +
                        "<span style='font-size: 0.85em;'>üìö Epistemic: " + (parseFloat(epistemic) * 100).toFixed(1) + "%</span><br>" +
                        "<span style='font-size: 0.85em;'>üé≤ Aleatoric: " + (parseFloat(aleatoric) * 100).toFixed(1) + "%</span><br>" +
                        "<span style='font-size: 0.85em;'>üìä Total: " + (parseFloat(totalUnc) * 100).toFixed(1) + "%</span>";
                }
                
                tooltip.innerHTML = tooltipHTML;
                tooltip.style.display = 'block';
            });
            
            node.addEventListener('mousemove', (e) => {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            });
            
            node.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        });
        
        // PDF Export Functionality
        document.getElementById('exportPdfBtn').addEventListener('click', async function() {
            const btn = this;
            btn.classList.add('loading');
            btn.innerHTML = '<span>‚è≥</span><span>Generating PDF...</span>';
            
            try {
                // Hide export toolbar for screenshot
                document.querySelector('.export-toolbar').style.display = 'none';
                
                // Use html2canvas to capture the page
                const canvas = await html2canvas(document.body, {
                    scale: 2, // Higher quality
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#667eea'
                });
                
                // Show toolbar again
                document.querySelector('.export-toolbar').style.display = 'flex';
                
                // Create PDF with jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // A4 dimensions: 210mm x 297mm
                const pdfWidth = 210;
                const pdfHeight = 297;
                
                // Calculate image dimensions to fit A4
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 10;
                
                // Add image to PDF
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                
                // Add metadata
                pdf.setProperties({
                    title: 'GDS XAI Saliency Map',
                    subject: 'Knowledge Graph Explainability',
                    author: 'GDS Reasoner',
                    keywords: 'XAI, explainability, knowledge graph',
                    creator: 'GDS v0.1'
                });
                
                // Save PDF
                const filename = 'gds_saliency_map_' + new Date().toISOString().slice(0,10) + '.pdf';
                pdf.save(filename);
                
                btn.classList.remove('loading');
                btn.innerHTML = '<span>‚úÖ</span><span>PDF Saved!</span>';
                setTimeout(() => {
                    btn.innerHTML = '<span>üìÑ</span><span>Export PDF</span>';
                }, 2000);
            } catch (error) {
                console.error('PDF export failed:', error);
                btn.classList.remove('loading');
                btn.innerHTML = '<span>‚ùå</span><span>Export Failed</span>';
                setTimeout(() => {
                    btn.innerHTML = '<span>üìÑ</span><span>Export PDF</span>';
                }, 2000);
            }
        });
        
        // SVG Download Functionality
        document.getElementById('exportSvgBtn').addEventListener('click', function() {
            const btn = this;
            btn.classList.add('loading');
            btn.innerHTML = '<span>‚è≥</span><span>Preparing SVG...</span>';
            
            try {
                // Get the SVG element
                const svgElement = document.querySelector('.svg-container svg');
                if (!svgElement) {
                    throw new Error('SVG not found');
                }
                
                // Clone SVG to avoid modifying original
                const svgClone = svgElement.cloneNode(true);
                
                // Add XML declaration and DOCTYPE
                const svgString = new XMLSerializer().serializeToString(svgClone);
                const svgBlob = new Blob(
                    ['<?xml version="1.0" encoding="UTF-8"?>', '\\n', svgString],
                    { type: 'image/svg+xml;charset=utf-8' }
                );
                
                // Create download link
                const url = URL.createObjectURL(svgBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'gds_saliency_map_' + new Date().toISOString().slice(0,10) + '.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                btn.classList.remove('loading');
                btn.innerHTML = '<span>‚úÖ</span><span>SVG Downloaded!</span>';
                setTimeout(() => {
                    btn.innerHTML = '<span>üé®</span><span>Download SVG</span>';
                }, 2000);
            } catch (error) {
                console.error('SVG download failed:', error);
                btn.classList.remove('loading');
                btn.innerHTML = '<span>‚ùå</span><span>Download Failed</span>';
                setTimeout(() => {
                    btn.innerHTML = '<span>üé®</span><span>Download SVG</span>';
                }, 2000);
            }
        });
    </script>
</body>
</html>